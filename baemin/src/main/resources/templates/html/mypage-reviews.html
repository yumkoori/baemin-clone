<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆì´ë°°ë¯¼ - ë¦¬ë·°ê´€ë¦¬</title>
    <link rel="stylesheet" href="/css/mypage.css">
</head>
<body>
<div class="baemin-page">
    <header class="appbar">
        <a class="icon-btn back" href="/api/mypage" aria-label="ë’¤ë¡œ">â†</a>
        <h1 class="appbar-title">ë§ˆì´ë°°ë¯¼</h1>
    </header>

    <main class="content">
        <section class="view active">
            <div class="page-title">ë¦¬ë·°ê´€ë¦¬</div>
            <div class="tabbar">
                <button class="tab active">ë°°ë‹¬Â·í”½ì—…</button>
                <button class="tab" disabled>ì¥ë³´ê¸°Â·ì‡¼í•‘</button>
            </div>
            <div class="review-count">ë‚´ê°€ ì“´ ì´ ë¦¬ë·° <b id="reviewCount" th:text="${(reviews != null) ? #lists.size(reviews) + 'ê°œ' : '0ê°œ'}">0ê°œ</b></div>

            <div id="reviewList" class="review-list">
                <article class="review-card" th:each="r : ${reviews}">
                    <header class="review-header">
                        <div>
                            <div class="store-name" th:text="${r.storeName}">ê°€ê²Œëª…</div>
                            <div class="meta" th:text="${#strings.repeat('â˜…', r.rating)}">â˜…â˜…â˜…â˜…â˜…</div>
                        </div>
                        <button class="small-btn" th:attr="data-id=${r.reviewId}">ì‚­ì œ</button>
                    </header>
                    <p class="review-text" th:text="${r.content}">ë¦¬ë·° ë‚´ìš©</p>
                    <div class="review-image" th:if="${r.reviewImage} != null"
                         th:style="${'background-image:url(' + r.reviewImage + ')'}"></div>
                </article>

                <p class="empty" th:if="${reviews == null or #lists.isEmpty(reviews)}">ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </section>
    </main>

    <nav class="bottombar">
        <a class="bottom-item" href="/api/main">
            <span>ğŸ </span>
            <span>í™ˆ</span>
        </a>
        <a class="bottom-item" href="#">
            <span>ğŸ›ï¸</span>
            <span>ì¥ë³´ê¸°Â·ì‡¼í•‘</span>
        </a>
        <a class="bottom-item" href="#">
            <span>â¤</span>
            <span>ì°œ</span>
        </a>
        <a class="bottom-item" href="#">
            <span>ğŸ§¾</span>
            <span>ì£¼ë¬¸ë‚´ì—­</span>
        </a>
        <a class="bottom-item active" href="/api/mypage">
            <span>ğŸ™‚</span>
            <span>ë§ˆì´ë°°ë¯¼</span>
        </a>
    </nav>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const updateCount = () => {
            const el = document.getElementById('reviewCount');
            if (!el) return;
            const count = document.querySelectorAll('#reviewList .review-card').length;
            el.textContent = count + 'ê°œ';
        };

        updateCount();

        const listEl = document.getElementById('reviewList');
        if (!listEl) return;

        listEl.addEventListener('click', async (e) => {
            const btn = e.target.closest('.small-btn');
            if (!btn || !listEl.contains(btn)) return;

            const reviewId = btn.getAttribute('data-id');
            if (!reviewId) return;

            if (!confirm('ì´ ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ì–´ìš”?')) return;

            try {
                const res = await fetch(`/api/user/reviews/${reviewId}`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: { 'Accept': 'application/json' }
                });

                let result = null;
                try { result = await res.json(); } catch (_) {}

                if (res.ok) {
                    const card = btn.closest('.review-card');
                    if (card) card.remove();
                    updateCount();

                    // ë¹„ì–´ìˆì„ ë•Œ ì•ˆë‚´ ì¶”ê°€
                    const remaining = document.querySelectorAll('#reviewList .review-card').length;
                    if (remaining === 0) {
                        const empty = document.createElement('p');
                        empty.className = 'empty';
                        empty.textContent = 'ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.';
                        listEl.appendChild(empty);
                    }

                    alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert((result && result.message) ? result.message : 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (err) {
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        });
    });
</script>
</body>
</html> 