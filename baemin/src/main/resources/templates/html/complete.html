<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>주문상세</title>
  <style>
    :root { --bg:#f6f7f9; --card:#fff; --ink:#111; --muted:#777; --line:#eee; --primary:#2ac1bc; }
    body { margin:0; background:var(--bg); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', sans-serif; color:var(--ink); }
    .page { max-width:560px; margin:0 auto; }
    .topbar { position:sticky; top:0; z-index:10; background:var(--primary); color:#fff; display:flex; align-items:center; justify-content:space-between; padding:12px 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .topbar .title { font-weight:700; font-size:18px; }
    .icon { width:28px; height:28px; display:flex; align-items:center; justify-content:center; border-radius:50%; color:#fff; cursor:pointer; }
    .card { background:var(--card); border-radius:12px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); padding:16px; margin:12px; }
    .row { display:flex; align-items:center; gap:10px; }
    .between { justify-content:space-between; }
    .muted { color:var(--muted); font-size:13px; }
    .badge { background:#f0f7ff; color:#3373ff; font-size:12px; padding:3px 8px; border-radius:999px; }
    .store { display:flex; align-items:center; gap:10px; text-decoration:none; color:inherit; }
    .store .logo { width:32px; height:32px; border-radius:8px; background:#f2f2f2; overflow:hidden; display:flex; align-items:center; justify-content:center; }
    .tabs { display:flex; gap:8px; padding:0 12px; }
    .tab { background:#fff; border:1px solid var(--line); border-radius:999px; padding:8px 12px; font-size:13px; text-decoration:none; color:inherit; }
    .section-title { font-weight:700; font-size:16px; margin:18px 14px 8px; }
    .menu-item { border:1px solid var(--line); border-radius:12px; padding:14px; }
    .menu-item .name { font-weight:700; }
    .menu-item .meta { font-size:13px; color:var(--muted); line-height:1.4; }
    .price { font-weight:700; }
    .btn { height:44px; display:flex; align-items:center; justify-content:center; border-radius:10px; background:#f2f2f2; color:#aaa; border:none; width:100%; font-weight:700; }
    .kv { display:flex; align-items:center; justify-content:space-between; margin:8px 0; }
    .divider { height:1px; background:var(--line); margin:12px 0; }
    .benefit { background:#f4f8ff; color:#4a7dfc; border-radius:12px; padding:12px; text-align:center; font-weight:700; }
    .ghost { background:#fff; border:1px solid var(--line); color:#333; }
    .cta { display:block; margin:12px; padding:14px; text-align:center; background:var(--primary); color:#fff; border-radius:10px; font-weight:700; text-decoration:none; }
    .help { font-size:12px; color:#9aa0a6; padding:0 16px 24px; line-height:1.6; }
    .loading { display:flex; justify-content:center; align-items:center; height:100vh; }
  </style>
</head>
<body>
  <div id="loading" class="loading">
    <div>주문 정보를 불러오는 중...</div>
  </div>
  <div class="page">
    <header class="topbar">
      <div class="icon" aria-label="back">‹</div>
      <div class="title">주문상세</div>
      <div class="icon" aria-label="menu">☰</div>
    </header>

    <section class="card">
      <div class="row between">
        <div>
          <div style="font-weight:700; margin-bottom:6px;">배달이 완료됐어요</div>
          <div class="muted">알뜰배달</div>
          <div class="muted" style="margin-top:6px;">
            <span>주문번호 </span><span id="orderNo">-</span>
          </div>
        </div>
      </div>
      <div class="row between" style="margin-top:12px;">
        <a class="store" href="#">
          <div class="logo"><span>🍕</span></div>
          <div id="storeName" style="font-weight:700;">가게명</div>
        </a>
        <div>🤍</div>
      </div>
    </section>

    <section class="card">
      <div class="row between">
        <div class="row">
          <div class="logo" style="width:36px;height:24px;">B</div>
          <div>
            <div style="font-weight:700;">배민 신한카드 발권쿠폰</div>
            <div class="muted">이 주문에서 1,840원 아낄 수 있어요!</div>
          </div>
        </div>
        <a class="muted" href="#">할인 받기</a>
      </div>
    </section>

    <nav class="tabs">
      <a class="tab" href="#order-menu">주문 메뉴</a>
      <a class="tab" href="#payment-info">결제 정보</a>
      <a class="tab" href="#delivery-info">배달 정보</a>
    </nav>

    <section id="order-menu" class="card">
      <div id="orderItemsList"></div>
      <div style="margin-top:12px;">
        <button class="btn" disabled>같은 메뉴 담기</button>
      </div>
    </section>

    <section id="payment-info" class="card">
      <div class="kv"><span>메뉴금액</span><strong id="menuAmount">0원</strong></div>
      <div class="kv"><span>배달팁</span><strong id="deliveryTip">0원</strong></div>
      <div class="kv"><span>총 할인받은 금액</span><strong style="color:#6c3cff;" id="discountTotal">- 0원</strong></div>
      <div class="divider"></div>
      <div class="kv" style="font-size:18px; font-weight:700;"><span>결제금액</span><span id="paymentAmount">0원</span></div>
      <div class="divider"></div>
      <div class="kv"><span>결제방법</span><span id="payMethod">카드</span></div>
    </section>

    <section class="card" style="padding:0;">
      <a class="cta" href="#"><span>카드영수증</span></a>
    </section>

    <div class="section-title">배달 정보</div>
    <section id="delivery-info" class="card">
      <div style="font-weight:700; margin-bottom:8px;">전화번호</div>
      <div class="muted">050-******** (안심번호)</div>
      <div class="muted">010-3261-4322</div>
      <div class="divider"></div>
      <div style="font-weight:700; margin-bottom:8px;">배달 주소</div>
      <div class="muted">서울 강남구 역삼동 735 한독빌딩 8층</div>
      <div class="muted">(도로명) 서울 강남구 테헤란로 132 한독빌딩 8층</div>
      <div class="divider"></div>
      <div style="font-weight:700; margin-bottom:8px;">라이더님께</div>
      <div class="muted">전화주시면 매장 나갈게요</div>
      <div class="divider"></div>
      <div style="font-weight:700; margin-bottom:8px;">가게 사장님께</div>
      <div class="muted">(수저, 포크 X) 나눠 먹을꺼라서, 사이즈 정밀하게 재단 해주세요. 감사합니다 사장님:)</div>
    </section>

    <section class="card" style="padding:0;">
      <a class="cta ghost" href="#">주문내역 삭제</a>
    </section>

    <div class="help">
      주문취소가 어려운 경우에는 중개이용료(2%~7.8%)와 결제중계수수료(1%~4%, 배달비 포함 최대 3,400원)를 부담합니다.<br/>
      일부 가게는 프로모션 적용으로 금액이 상이할 수 있으며, 변경될 수 있습니다.
      <br/><br/>
      고객센터(대표) 1600-0987 / 24시간 운영, 명절 휴무 / ARS 번호 안내
    </div>
  </div>

  <script>
    // 숫자 포맷팅
    function formatNumber(num) {
      return new Intl.NumberFormat('ko-KR').format(num);
    }

    // URL에서 paymentId 추출
    function getPaymentIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('paymentId');
    }

    // 주문 정보 조회 및 화면 업데이트
    async function loadOrderInfo(retryCount = 0) {
      const paymentId = getPaymentIdFromUrl();
      
      if (!paymentId) {
        console.error('paymentId가 없습니다.');
        document.getElementById('loading').style.display = 'none';
        alert('결제 정보를 찾을 수 없습니다.');
        return;
      }

      try {
        console.log(`[${retryCount}] API 호출 시작 - paymentId: ${paymentId}`);
        const response = await fetch(`/api/payment/order-info?paymentId=${paymentId}`);
        
        if (!response.ok) {
          console.error(`[${retryCount}] API 응답 실패 - status: ${response.status}`);
          throw new Error('주문 정보 조회 실패');
        }

        const data = await response.json();
        console.log(`[${retryCount}] 받은 데이터:`, data);
        
        if (data.success) {
          // 주문이 아직 생성 중인 경우 재시도 (최대 10회, 500ms 간격)
          if (data.pending && retryCount < 10) {
            console.log(`[${retryCount}] pending=true, 재시도 예약 (${retryCount + 1}/10)`);
            setTimeout(() => loadOrderInfo(retryCount + 1), 500);
            return; // 재시도만 하고, 화면 업데이트는 하지 않음
          }
          
          // 재시도를 다 써도 주문이 없는 경우
          if (data.pending && retryCount >= 10) {
            console.error('[TIMEOUT] 주문 생성 시간 초과');
            alert('주문 정보를 불러오는데 시간이 너무 오래 걸립니다. 잠시 후 다시 시도해주세요.');
            document.getElementById('loading').style.display = 'none';
            return;
          }
          
          console.log(`[${retryCount}] 화면 업데이트 시작 - pending=${data.pending}`);
          
          // 주문 번호 및 가게명
          document.getElementById('orderNo').textContent = data.orderNo || '-';
          document.getElementById('storeName').textContent = data.storeName || '가게명';
          
          // 주문 메뉴 목록
          const orderItemsList = document.getElementById('orderItemsList');
          orderItemsList.innerHTML = '';
          
          if (data.orderItems && data.orderItems.length > 0) {
            console.log(`[${retryCount}] 메뉴 ${data.orderItems.length}개 표시`);
            data.orderItems.forEach(item => {
              const itemHtml = `
                <div class="menu-item">
                  <div class="name">${item.menuName}</div>
                  <div class="meta">
                    <div>가격: ${formatNumber(item.basePrice)}원</div>
                  </div>
                  <div class="row between" style="margin-top:10px;">
                    <div class="price">
                      ${formatNumber(item.lineTotal)}원
                      <span class="muted">${item.quantity}개</span>
                    </div>
                  </div>
                </div>
              `;
              orderItemsList.insertAdjacentHTML('beforeend', itemHtml);
            });
          } else {
            console.warn(`[${retryCount}] 메뉴 항목 없음`);
          }
          
          // 결제 정보
          console.log(`[${retryCount}] 금액 정보 - 메뉴: ${data.menuAmount}, 배달팁: ${data.deliveryTip}, 결제: ${data.paymentAmount}`);
          document.getElementById('menuAmount').textContent = formatNumber(data.menuAmount || 0) + '원';
          document.getElementById('deliveryTip').textContent = formatNumber(data.deliveryTip || 0) + '원';
          document.getElementById('discountTotal').textContent = '- ' + formatNumber(data.discountTotal || 0) + '원';
          document.getElementById('paymentAmount').textContent = formatNumber(data.paymentAmount || 0) + '원';
          document.getElementById('payMethod').textContent = data.payMethod || '카드';
          
          // 로딩 숨기기
          document.getElementById('loading').style.display = 'none';
          console.log(`[${retryCount}] 화면 업데이트 완료`);
          
        } else {
          throw new Error(data.message || '주문 정보 조회 실패');
        }
        
      } catch (error) {
        console.error('주문 정보 조회 실패:', error);
        document.getElementById('loading').style.display = 'none';
        alert('주문 정보를 불러오는데 실패했습니다.');
      }
    }

    // 페이지 로드 시 실행
    document.addEventListener('DOMContentLoaded', function() {
      loadOrderInfo(0);
    });
  </script>
</body>
</html>
