<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì£¼ë¬¸ìƒì„¸</title>
  <style>
    :root { --bg:#f6f7f9; --card:#fff; --ink:#111; --muted:#777; --line:#eee; --primary:#2ac1bc; }
    body { margin:0; background:var(--bg); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', sans-serif; color:var(--ink); }
    .page { max-width:560px; margin:0 auto; }
    .topbar { position:sticky; top:0; z-index:10; background:var(--primary); color:#fff; display:flex; align-items:center; justify-content:space-between; padding:12px 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .topbar .title { font-weight:700; font-size:18px; }
    .icon { width:28px; height:28px; display:flex; align-items:center; justify-content:center; border-radius:50%; color:#fff; cursor:pointer; }
    .card { background:var(--card); border-radius:12px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); padding:16px; margin:12px; }
    .row { display:flex; align-items:center; gap:10px; }
    .between { justify-content:space-between; }
    .muted { color:var(--muted); font-size:13px; }
    .badge { background:#f0f7ff; color:#3373ff; font-size:12px; padding:3px 8px; border-radius:999px; }
    .store { display:flex; align-items:center; gap:10px; text-decoration:none; color:inherit; }
    .store .logo { width:32px; height:32px; border-radius:8px; background:#f2f2f2; overflow:hidden; display:flex; align-items:center; justify-content:center; }
    .tabs { display:flex; gap:8px; padding:0 12px; }
    .tab { background:#fff; border:1px solid var(--line); border-radius:999px; padding:8px 12px; font-size:13px; text-decoration:none; color:inherit; }
    .section-title { font-weight:700; font-size:16px; margin:18px 14px 8px; }
    .menu-item { border:1px solid var(--line); border-radius:12px; padding:14px; }
    .menu-item .name { font-weight:700; }
    .menu-item .meta { font-size:13px; color:var(--muted); line-height:1.4; }
    .price { font-weight:700; }
    .btn { height:44px; display:flex; align-items:center; justify-content:center; border-radius:10px; background:#f2f2f2; color:#aaa; border:none; width:100%; font-weight:700; }
    .kv { display:flex; align-items:center; justify-content:space-between; margin:8px 0; }
    .divider { height:1px; background:var(--line); margin:12px 0; }
    .benefit { background:#f4f8ff; color:#4a7dfc; border-radius:12px; padding:12px; text-align:center; font-weight:700; }
    .ghost { background:#fff; border:1px solid var(--line); color:#333; }
    .cta { display:block; margin:12px; padding:14px; text-align:center; background:var(--primary); color:#fff; border-radius:10px; font-weight:700; text-decoration:none; }
    .help { font-size:12px; color:#9aa0a6; padding:0 16px 24px; line-height:1.6; }
    .loading { display:flex; justify-content:center; align-items:center; height:100vh; }
  </style>
</head>
<body>
  <div id="loading" class="loading">
    <div>ì£¼ë¬¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  </div>
  <div class="page">
    <header class="topbar">
      <div class="icon" aria-label="back">â€¹</div>
      <div class="title">ì£¼ë¬¸ìƒì„¸</div>
      <div class="icon" aria-label="menu">â˜°</div>
    </header>

    <section class="card">
      <div class="row between">
        <div>
          <div style="font-weight:700; margin-bottom:6px;">ë°°ë‹¬ì´ ì™„ë£Œëì–´ìš”</div>
          <div class="muted">ì•Œëœ°ë°°ë‹¬</div>
          <div class="muted" style="margin-top:6px;">
            <span>ì£¼ë¬¸ë²ˆí˜¸ </span><span id="orderNo">-</span>
          </div>
        </div>
      </div>
      <div class="row between" style="margin-top:12px;">
        <a class="store" href="#">
          <div class="logo"><span>ğŸ•</span></div>
          <div id="storeName" style="font-weight:700;">ê°€ê²Œëª…</div>
        </a>
        <div>ğŸ¤</div>
      </div>
    </section>

    <section class="card">
      <div class="row between">
        <div class="row">
          <div class="logo" style="width:36px;height:24px;">B</div>
          <div>
            <div style="font-weight:700;">ë°°ë¯¼ ì‹ í•œì¹´ë“œ ë°œê¶Œì¿ í°</div>
            <div class="muted">ì´ ì£¼ë¬¸ì—ì„œ 1,840ì› ì•„ë‚„ ìˆ˜ ìˆì–´ìš”!</div>
          </div>
        </div>
        <a class="muted" href="#">í• ì¸ ë°›ê¸°</a>
      </div>
    </section>

    <nav class="tabs">
      <a class="tab" href="#order-menu">ì£¼ë¬¸ ë©”ë‰´</a>
      <a class="tab" href="#payment-info">ê²°ì œ ì •ë³´</a>
      <a class="tab" href="#delivery-info">ë°°ë‹¬ ì •ë³´</a>
    </nav>

    <section id="order-menu" class="card">
      <div id="orderItemsList"></div>
      <div style="margin-top:12px;">
        <button class="btn" disabled>ê°™ì€ ë©”ë‰´ ë‹´ê¸°</button>
      </div>
    </section>

    <section id="payment-info" class="card">
      <div class="kv"><span>ë©”ë‰´ê¸ˆì•¡</span><strong id="menuAmount">0ì›</strong></div>
      <div class="kv"><span>ë°°ë‹¬íŒ</span><strong id="deliveryTip">0ì›</strong></div>
      <div class="kv"><span>ì´ í• ì¸ë°›ì€ ê¸ˆì•¡</span><strong style="color:#6c3cff;" id="discountTotal">- 0ì›</strong></div>
      <div class="divider"></div>
      <div class="kv" style="font-size:18px; font-weight:700;"><span>ê²°ì œê¸ˆì•¡</span><span id="paymentAmount">0ì›</span></div>
      <div class="divider"></div>
      <div class="kv"><span>ê²°ì œë°©ë²•</span><span id="payMethod">ì¹´ë“œ</span></div>
    </section>

    <section class="card" style="padding:0;">
      <a class="cta" href="#"><span>ì¹´ë“œì˜ìˆ˜ì¦</span></a>
    </section>

    <div class="section-title">ë°°ë‹¬ ì •ë³´</div>
    <section id="delivery-info" class="card">
      <div style="font-weight:700; margin-bottom:8px;">ì „í™”ë²ˆí˜¸</div>
      <div class="muted">050-******** (ì•ˆì‹¬ë²ˆí˜¸)</div>
      <div class="muted">010-3261-4322</div>
      <div class="divider"></div>
      <div style="font-weight:700; margin-bottom:8px;">ë°°ë‹¬ ì£¼ì†Œ</div>
      <div class="muted">ì„œìš¸ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™ 735 í•œë…ë¹Œë”© 8ì¸µ</div>
      <div class="muted">(ë„ë¡œëª…) ì„œìš¸ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 132 í•œë…ë¹Œë”© 8ì¸µ</div>
      <div class="divider"></div>
      <div style="font-weight:700; margin-bottom:8px;">ë¼ì´ë”ë‹˜ê»˜</div>
      <div class="muted">ì „í™”ì£¼ì‹œë©´ ë§¤ì¥ ë‚˜ê°ˆê²Œìš”</div>
      <div class="divider"></div>
      <div style="font-weight:700; margin-bottom:8px;">ê°€ê²Œ ì‚¬ì¥ë‹˜ê»˜</div>
      <div class="muted">(ìˆ˜ì €, í¬í¬ X) ë‚˜ëˆ  ë¨¹ì„êº¼ë¼ì„œ, ì‚¬ì´ì¦ˆ ì •ë°€í•˜ê²Œ ì¬ë‹¨ í•´ì£¼ì„¸ìš”. ê°ì‚¬í•©ë‹ˆë‹¤ ì‚¬ì¥ë‹˜:)</div>
    </section>

    <section class="card" style="padding:0;">
      <a class="cta ghost" href="#">ì£¼ë¬¸ë‚´ì—­ ì‚­ì œ</a>
    </section>

    <div class="help">
      ì£¼ë¬¸ì·¨ì†Œê°€ ì–´ë ¤ìš´ ê²½ìš°ì—ëŠ” ì¤‘ê°œì´ìš©ë£Œ(2%~7.8%)ì™€ ê²°ì œì¤‘ê³„ìˆ˜ìˆ˜ë£Œ(1%~4%, ë°°ë‹¬ë¹„ í¬í•¨ ìµœëŒ€ 3,400ì›)ë¥¼ ë¶€ë‹´í•©ë‹ˆë‹¤.<br/>
      ì¼ë¶€ ê°€ê²ŒëŠ” í”„ë¡œëª¨ì…˜ ì ìš©ìœ¼ë¡œ ê¸ˆì•¡ì´ ìƒì´í•  ìˆ˜ ìˆìœ¼ë©°, ë³€ê²½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      <br/><br/>
      ê³ ê°ì„¼í„°(ëŒ€í‘œ) 1600-0987 / 24ì‹œê°„ ìš´ì˜, ëª…ì ˆ íœ´ë¬´ / ARS ë²ˆí˜¸ ì•ˆë‚´
    </div>
  </div>

  <script>
    // ìˆ«ì í¬ë§·íŒ…
    function formatNumber(num) {
      return new Intl.NumberFormat('ko-KR').format(num);
    }

    // URLì—ì„œ paymentId ì¶”ì¶œ
    function getPaymentIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('paymentId');
    }

    // ì£¼ë¬¸ ì •ë³´ ì¡°íšŒ ë° í™”ë©´ ì—…ë°ì´íŠ¸
    async function loadOrderInfo(retryCount = 0) {
      const paymentId = getPaymentIdFromUrl();
      
      if (!paymentId) {
        console.error('paymentIdê°€ ì—†ìŠµë‹ˆë‹¤.');
        document.getElementById('loading').style.display = 'none';
        alert('ê²°ì œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      try {
        console.log(`[${retryCount}] API í˜¸ì¶œ ì‹œì‘ - paymentId: ${paymentId}`);
        const response = await fetch(`/api/payment/order-info?paymentId=${paymentId}`);
        
        if (!response.ok) {
          console.error(`[${retryCount}] API ì‘ë‹µ ì‹¤íŒ¨ - status: ${response.status}`);
          throw new Error('ì£¼ë¬¸ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨');
        }

        const data = await response.json();
        console.log(`[${retryCount}] ë°›ì€ ë°ì´í„°:`, data);
        
        if (data.success) {
          // ì£¼ë¬¸ì´ ì•„ì§ ìƒì„± ì¤‘ì¸ ê²½ìš° ì¬ì‹œë„ (ìµœëŒ€ 10íšŒ, 500ms ê°„ê²©)
          if (data.pending && retryCount < 10) {
            console.log(`[${retryCount}] pending=true, ì¬ì‹œë„ ì˜ˆì•½ (${retryCount + 1}/10)`);
            setTimeout(() => loadOrderInfo(retryCount + 1), 500);
            return; // ì¬ì‹œë„ë§Œ í•˜ê³ , í™”ë©´ ì—…ë°ì´íŠ¸ëŠ” í•˜ì§€ ì•ŠìŒ
          }
          
          // ì¬ì‹œë„ë¥¼ ë‹¤ ì¨ë„ ì£¼ë¬¸ì´ ì—†ëŠ” ê²½ìš°
          if (data.pending && retryCount >= 10) {
            console.error('[TIMEOUT] ì£¼ë¬¸ ìƒì„± ì‹œê°„ ì´ˆê³¼');
            alert('ì£¼ë¬¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹œê°„ì´ ë„ˆë¬´ ì˜¤ë˜ ê±¸ë¦½ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            document.getElementById('loading').style.display = 'none';
            return;
          }
          
          console.log(`[${retryCount}] í™”ë©´ ì—…ë°ì´íŠ¸ ì‹œì‘ - pending=${data.pending}`);
          
          // ì£¼ë¬¸ ë²ˆí˜¸ ë° ê°€ê²Œëª…
          document.getElementById('orderNo').textContent = data.orderNo || '-';
          document.getElementById('storeName').textContent = data.storeName || 'ê°€ê²Œëª…';
          
          // ì£¼ë¬¸ ë©”ë‰´ ëª©ë¡
          const orderItemsList = document.getElementById('orderItemsList');
          orderItemsList.innerHTML = '';
          
          if (data.orderItems && data.orderItems.length > 0) {
            console.log(`[${retryCount}] ë©”ë‰´ ${data.orderItems.length}ê°œ í‘œì‹œ`);
            data.orderItems.forEach(item => {
              const itemHtml = `
                <div class="menu-item">
                  <div class="name">${item.menuName}</div>
                  <div class="meta">
                    <div>ê°€ê²©: ${formatNumber(item.basePrice)}ì›</div>
                  </div>
                  <div class="row between" style="margin-top:10px;">
                    <div class="price">
                      ${formatNumber(item.lineTotal)}ì›
                      <span class="muted">${item.quantity}ê°œ</span>
                    </div>
                  </div>
                </div>
              `;
              orderItemsList.insertAdjacentHTML('beforeend', itemHtml);
            });
          } else {
            console.warn(`[${retryCount}] ë©”ë‰´ í•­ëª© ì—†ìŒ`);
          }
          
          // ê²°ì œ ì •ë³´
          console.log(`[${retryCount}] ê¸ˆì•¡ ì •ë³´ - ë©”ë‰´: ${data.menuAmount}, ë°°ë‹¬íŒ: ${data.deliveryTip}, ê²°ì œ: ${data.paymentAmount}`);
          document.getElementById('menuAmount').textContent = formatNumber(data.menuAmount || 0) + 'ì›';
          document.getElementById('deliveryTip').textContent = formatNumber(data.deliveryTip || 0) + 'ì›';
          document.getElementById('discountTotal').textContent = '- ' + formatNumber(data.discountTotal || 0) + 'ì›';
          document.getElementById('paymentAmount').textContent = formatNumber(data.paymentAmount || 0) + 'ì›';
          document.getElementById('payMethod').textContent = data.payMethod || 'ì¹´ë“œ';
          
          // ë¡œë”© ìˆ¨ê¸°ê¸°
          document.getElementById('loading').style.display = 'none';
          console.log(`[${retryCount}] í™”ë©´ ì—…ë°ì´íŠ¸ ì™„ë£Œ`);
          
        } else {
          throw new Error(data.message || 'ì£¼ë¬¸ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨');
        }
        
      } catch (error) {
        console.error('ì£¼ë¬¸ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
        document.getElementById('loading').style.display = 'none';
        alert('ì£¼ë¬¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', function() {
      loadOrderInfo(0);
    });
  </script>
</body>
</html>
