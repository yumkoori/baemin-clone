<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¿ í° ë°œê¸‰ - ë°°ë‹¬ì˜ë¯¼ì¡±</title>
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/coupon-event.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- í—¤ë” -->
    <header class="header">
        <div class="header-container">
            <div class="header-left">
                <a th:href="@{/api/main}" class="back-button">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <h1 class="page-title">ì¿ í° ì´ë²¤íŠ¸</h1>
            </div>
        </div>
    </header>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="main-content">
        <!-- ì¿ í° ì´ë²¤íŠ¸ í˜ì´ì§€ -->
        <div class="coupon-detail-container">
            <div class="event-banner">
                <div class="event-banner-content">
                    <div class="event-icon">ğŸ‰</div>
                    <h2 class="event-title">ì„ ì°©ìˆœ íŠ¹ë³„ ì´ë²¤íŠ¸</h2>
                    <p class="event-subtitle">ì§€ê¸ˆ ë°”ë¡œ ë°›ì•„ê°€ì„¸ìš”!</p>
                </div>
            </div>

            <div class="coupon-card large">
                <div class="coupon-header">
                    <div class="coupon-discount">
                        <span class="discount-amount">5,000ì›</span>
                        <span class="discount-label">í• ì¸</span>
                    </div>
                </div>
                <div class="coupon-body">
                    <h3 class="coupon-name">5ì²œì› í• ì¸ ì¿ í°</h3>
                    <p class="coupon-description">ì„ ì°©ìˆœ 100ëª… í•œì •! ëª¨ë“  ì£¼ë¬¸ì— ì‚¬ìš© ê°€ëŠ¥</p>
                    <div class="coupon-details">
                        <div class="detail-item">
                            <i class="fas fa-receipt"></i>
                            <span>ìµœì†Œ ì£¼ë¬¸ê¸ˆì•¡: <strong>15,000ì›</strong></span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-calendar-alt"></i>
                            <span>ìœ íš¨ê¸°ê°„: <strong>ë°œê¸‰ì¼ë¡œë¶€í„° 3ì¼</strong></span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-users"></i>
                            <span>ë‚¨ì€ ìˆ˜ëŸ‰: <strong id="remaining-count">100ëª…</strong></span>
                        </div>
                    </div>
                </div>
                <div class="coupon-footer">
                    <button id="issueCouponBtn" 
                            class="issue-button"
                            onclick="issueCoupon()">
                        <i class="fas fa-gift"></i>
                        ì¿ í° ë°›ê¸°
                    </button>
                </div>
            </div>

            <div class="info-section">
                <h3>ìœ ì˜ì‚¬í•­</h3>
                <ul class="info-list">
                    <li>ë³¸ ì¿ í°ì€ ì„ ì°©ìˆœ 100ëª… í•œì •ì…ë‹ˆë‹¤.</li>
                    <li>1ì¸ë‹¹ 1íšŒë§Œ ë°œê¸‰ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
                    <li>ìµœì†Œ ì£¼ë¬¸ê¸ˆì•¡ 15,000ì› ì´ìƒ ì£¼ë¬¸ ì‹œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
                    <li>ë‹¤ë¥¸ ì¿ í°ê³¼ ì¤‘ë³µ ì‚¬ìš©ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
                    <li>ë°œê¸‰ì¼ë¡œë¶€í„° 3ì¼ ì´ë‚´ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ì‚¬ìš©ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.</li>
                    <li>ë°œê¸‰ëœ ì¿ í°ì€ ë§ˆì´í˜ì´ì§€ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                </ul>
            </div>
        </div>
    </main>

    <!-- ëª¨ë‹¬ -->
    <div id="resultModal" class="modal">
        <div class="modal-content">
            <div class="modal-icon" id="modalIcon"></div>
            <h3 id="modalTitle"></h3>
            <p id="modalMessage"></p>
            <button class="modal-button" onclick="closeModal()">í™•ì¸</button>
        </div>
    </div>

    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë‚¨ì€ ìˆ˜ëŸ‰ ì¡°íšŒ
        window.addEventListener('DOMContentLoaded', function() {
            updateRemainingCount();
            // 3ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹ 
            setInterval(updateRemainingCount, 3000);
        });

        // ë‚¨ì€ ì¿ í° ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸
        function updateRemainingCount() {
            fetch('/api/coupon/remaining')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const remainingElement = document.getElementById('remaining-count');
                        const remaining = data.remaining;
                        
                        // ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸
                        remainingElement.textContent = remaining + 'ëª…';
                        
                        // ìˆ˜ëŸ‰ì— ë”°ë¼ ìƒ‰ìƒ ë³€ê²½
                        if (remaining <= 0) {
                            remainingElement.style.color = '#ff4444';
                            remainingElement.textContent = 'í’ˆì ˆ';
                        } else if (remaining <= 10) {
                            remainingElement.style.color = '#ff9800';
                        } else {
                            remainingElement.style.color = '#4caf50';
                        }
                        
                        console.log(`í˜„ì¬ ì¬ê³ : ${data.currentStock}/${data.maxStock}, ë‚¨ì€ ìˆ˜ëŸ‰: ${remaining}`);
                    }
                })
                .catch(error => {
                    console.error('ìˆ˜ëŸ‰ ì¡°íšŒ ì‹¤íŒ¨:', error);
                });
        }

        function issueCoupon() {
            const button = document.getElementById('issueCouponBtn');
            
            fetch('/api/coupon/issue', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.text())
            .then(message => {
                if (message.includes('ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤')) {
                    showModal('success', 'ì„±ê³µ!', message);
                    // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                    button.innerHTML = '<i class="fas fa-check"></i> ë°œê¸‰ ì™„ë£Œ';
                    button.className = 'issued-button';
                    button.disabled = true;
                    
                    // ì¦‰ì‹œ ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸
                    updateRemainingCount();
                } else {
                    showModal('error', 'ì•Œë¦¼', message);
                    
                    // ì˜¤ë¥˜ ì‹œì—ë„ ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸ (ì¬ê³  ì†Œì§„ í™•ì¸)
                    updateRemainingCount();
                }
            })
            .catch(error => {
                showModal('error', 'ì˜¤ë¥˜', 'ì¿ í° ë°œê¸‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error('Error:', error);
            });
        }

        function showModal(type, title, message) {
            const modal = document.getElementById('resultModal');
            const modalIcon = document.getElementById('modalIcon');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');

            modalTitle.textContent = title;
            modalMessage.textContent = message;

            if (type === 'success') {
                modalIcon.innerHTML = '<i class="fas fa-check-circle" style="color: #4caf50;"></i>';
            } else {
                modalIcon.innerHTML = '<i class="fas fa-exclamation-circle" style="color: #ff9800;"></i>';
            }

            modal.style.display = 'flex';
        }

        function closeModal() {
            const modal = document.getElementById('resultModal');
            modal.style.display = 'none';
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            const modal = document.getElementById('resultModal');
            if (event.target == modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>

