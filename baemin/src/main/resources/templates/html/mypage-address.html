<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆì´ë°°ë¯¼ - ì£¼ì†Œ ê´€ë¦¬</title>
    <link rel="stylesheet" href="/css/mypage.css">
</head>
<body>
<div class="baemin-page">
    <header class="appbar">
        <a class="icon-btn back" href="/api/mypage" aria-label="ë’¤ë¡œ">â†</a>
        <h1 class="appbar-title">ë§ˆì´ë°°ë¯¼</h1>
    </header>

    <main class="content">
        <section class="view active">
            <div class="page-title">ì£¼ì†Œ í¸ì§‘</div>
            <div class="address-head">
                <button class="primary-btn" onclick="openOnboardingAddress()">ìƒˆ ì£¼ì†Œ ì¶”ê°€</button>
            </div>
            <!-- ì„œë²„ ì‚¬ì´ë“œ ë Œë”ë§ (SSR) â†’ íƒ€ì„ë¦¬í”„: addresses ëª¨ë¸ ì‚¬ìš© -->
            <div id="addressList" class="address-list">
                <div th:if="${#lists.isEmpty(addresses)}" class="empty">ë“±ë¡ëœ ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                <div th:each="addr : ${addresses}"
                     th:classappend="${addr.default} ? ' default' : ''"
                     class="addr-item">
                    <div class="addr-top">
                        <div class="addr-title" th:style="${addr.default} ? 'font-weight:900' : 'font-weight:600'"
                             th:text="${addr.alias}"></div>
                        <span class="badge" th:if="${addr.default}">ê¸°ë³¸ ì£¼ì†Œ</span>
                    </div>
                    <div class="addr-sub"
                         th:text="${addr.roadAddress} + ' ' + (${addr.detailAddress} != null ? addr.detailAddress : '')"></div>
                    <div class="addr-actions">
                        <button class="small-outline" th:if="!${addr.default}"
                                th:attr="onclick='makeDefault(' + ${addr.id} + ')'"><span>ëŒ€í‘œë¡œ</span></button>
                        <button class="small-outline"
                                th:attr="onclick='openAddressModal(' + ${addr.id} + ')'"><span>ìˆ˜ì •</span></button>
                        <button class="small-danger"
                                th:attr="onclick='deleteAddress(' + ${addr.id} + ')'"><span>ì‚­ì œ</span></button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <nav class="bottombar">
        <a class="bottom-item" href="/api/main">
            <span>ğŸ </span>
            <span>í™ˆ</span>
        </a>
        <a class="bottom-item" href="#">
            <span>ğŸ›ï¸</span>
            <span>ì¥ë³´ê¸°Â·ì‡¼í•‘</span>
        </a>
        <a class="bottom-item" href="#">
            <span>â¤</span>
            <span>ì°œ</span>
        </a>
        <a class="bottom-item" href="#">
            <span>ğŸ§¾</span>
            <span>ì£¼ë¬¸ë‚´ì—­</span>
        </a>
        <a class="bottom-item active" href="/api/mypage">
            <span>ğŸ™‚</span>
            <span>ë§ˆì´ë°°ë¯¼</span>
        </a>
    </nav>
</div>

<!-- ì£¼ì†Œ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
<div id="addressModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">ì£¼ì†Œ ê´€ë¦¬</h3>
            <button class="close-btn" onclick="closeAddressModal()">Ã—</button>
        </div>
        <form id="addressForm" onsubmit="saveAddress(event)">
            <div class="form-group">
                <label class="form-label">ì£¼ì†Œëª… (ë³„ì¹­)</label>
                <input type="text" class="form-input" id="addressAlias" placeholder="ì˜ˆ: ì§‘, íšŒì‚¬, í•™êµ" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">ìš°í¸ë²ˆí˜¸</label>
                    <input type="text" class="form-input" id="zipCode" placeholder="ìš°í¸ë²ˆí˜¸" required>
                </div>
                <div class="form-group">
                    <button type="button" class="btn btn-secondary" onclick="searchAddress()">ì£¼ì†Œ ê²€ìƒ‰</button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">ë„ë¡œëª… ì£¼ì†Œ</label>
                <input type="text" class="form-input" id="roadAddress" placeholder="ë„ë¡œëª… ì£¼ì†Œ" required readonly>
            </div>
            <div class="form-group">
                <label class="form-label">ìƒì„¸ ì£¼ì†Œ</label>
                <input type="text" class="form-input" id="detailAddress" placeholder="ìƒì„¸ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="isDefault"> ê¸°ë³¸ ë°°ì†¡ì§€ë¡œ ì„¤ì •</label>
            </div>
            <div class="form-group modal-actions">
                <button type="submit" class="btn btn-primary">ì €ì¥</button>
                <button type="button" class="btn btn-secondary" onclick="closeAddressModal()">ì·¨ì†Œ</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openAddressModal(addressId = null) {
        document.getElementById('addressModal').style.display = 'block';
        if (addressId) loadAddressForEdit(addressId); else document.getElementById('addressForm').reset();
    }
    function openOnboardingAddress() {
        const alias = prompt('ì£¼ì†Œ ë³„ì¹­(ì˜ˆ: ì§‘, íšŒì‚¬)ì„ ì…ë ¥í•˜ì„¸ìš”', 'ì§‘');
        const q = alias ? ('?return=' + encodeURIComponent('/api/mypage/address') + '&alias=' + encodeURIComponent(alias))
                        : ('?return=' + encodeURIComponent('/api/mypage/address'));
        window.location.href = '/api/onboarding/address' + q;
    }
    function closeAddressModal() { document.getElementById('addressModal').style.display = 'none'; }

    async function loadAddressForEdit(addressId) {
        try {
            const response = await fetch(`/api/user/addresses/${addressId}`, { credentials: 'include' });
            const result = await response.json();
            if (result.resultCode === 200) {
                const a = result.data;
                document.getElementById('addressAlias').value = a.alias;
                document.getElementById('zipCode').value = a.zipCode;
                document.getElementById('roadAddress').value = a.roadAddress;
                document.getElementById('detailAddress').value = a.detailAddress || '';
                // boolean í‚¤ê°€ isDefault ë˜ëŠ” default ë‘˜ ì¤‘ í•˜ë‚˜ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ëª¨ë‘ ëŒ€ì‘
                document.getElementById('isDefault').checked = (a.isDefault ?? a.default) === true;
            } else { alert('ì£¼ì†Œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); }
        } catch (e) { console.error(e); alert('ì£¼ì†Œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜'); }
    }

    async function loadAddressList() {
        try {
            const response = await fetch('/api/user/addresses', { credentials: 'include' });
            const result = await response.json();
            if (result.resultCode === 200) { renderAddressList(result.data); }
        } catch (e) { console.error('ì£¼ì†Œ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜', e); }
    }

    function renderAddressList(addresses) {
        const wrap = document.getElementById('addressList');
        if (!wrap) return;
        if (!addresses || addresses.length === 0) {
            wrap.innerHTML = '<p class="empty">ë“±ë¡ëœ ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }
        // ê¸°ë³¸ ì£¼ì†Œ ë§¨ ìœ„ ì •ë ¬ (isDefault ë˜ëŠ” default í‚¤ ëª¨ë‘ ì§€ì›)
        addresses.sort((a,b)=> ((b.isDefault ?? b.default) ? 1 : 0) - ((a.isDefault ?? a.default) ? 1 : 0));
        wrap.innerHTML = addresses.map(a => {
            const isDef = (a.isDefault ?? a.default) === true;
            return `
            <div class="addr-item ${isDef ? 'default' : ''}">
                <div class="addr-top">
                    <div class="addr-title" style="${isDef ? 'font-weight:900' : 'font-weight:600'}">${a.alias}</div>
                    ${isDef ? '<span class="badge">ê¸°ë³¸ ì£¼ì†Œ</span>' : ''}
                </div>
                <div class="addr-sub">${a.roadAddress} ${a.detailAddress || ''}</div>
                <div class="addr-actions">
                    ${!isDef ? `<button class="small-outline" onclick="makeDefault(${a.id})">ëŒ€í‘œë¡œ</button>` : ''}
                    <button class="small-outline" onclick="openAddressModal(${a.id})">ìˆ˜ì •</button>
                    <button class="small-danger" onclick="deleteAddress(${a.id})">ì‚­ì œ</button>
                </div>
            </div>`;
        }).join('');
    }

    async function saveAddress(event) {
        event.preventDefault();
        const data = {
            alias: document.getElementById('addressAlias').value,
            zipCode: document.getElementById('zipCode').value,
            roadAddress: document.getElementById('roadAddress').value,
            detailAddress: document.getElementById('detailAddress').value,
            isDefault: document.getElementById('isDefault').checked === true
        };
        try {
            const res = await fetch('/api/user/addresses', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify(data)
            });
            const result = await res.json();
            if (result.resultCode === 200) { closeAddressModal(); loadAddressList(); }
            else alert('ì£¼ì†Œ ì €ì¥ ì‹¤íŒ¨: ' + result.message);
        } catch (e) { console.error(e); alert('ì£¼ì†Œ ì €ì¥ ì¤‘ ì˜¤ë¥˜'); }
    }

    function searchAddress() { alert('ì£¼ì†Œ ê²€ìƒ‰ì€ ë°ëª¨ í™”ë©´ì…ë‹ˆë‹¤. ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'); }

    async function deleteAddress(addressId) {
        if (!confirm('ì´ ì£¼ì†Œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try {
            const res = await fetch(`/api/user/addresses/${addressId}`, { method: 'DELETE', credentials: 'include' });
            const result = await res.json();
            if (result.resultCode === 200) loadAddressList();
            else alert('ì‚­ì œ ì‹¤íŒ¨: ' + result.message);
        } catch (e) { console.error(e); alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜'); }
    }

    async function setDefaultAddress(addressId) {
        try {
            const res = await fetch(`/api/user/addresses/${addressId}/default`, { method: 'POST', credentials: 'include' });
            const result = await res.json();
            if (result.resultCode === 200) loadAddressList();
            else alert('ê¸°ë³¸ ì„¤ì • ì‹¤íŒ¨: ' + result.message);
        } catch (e) { console.error(e); alert('ê¸°ë³¸ ì„¤ì • ì¤‘ ì˜¤ë¥˜'); }
    }

    async function makeDefault(addressId) {
        if (!confirm('ì´ ì£¼ì†Œë¥¼ ëŒ€í‘œ ì£¼ì†Œë¡œ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        await setDefaultAddress(addressId);
    }

    window.addEventListener('click', (e) => {
        const modal = document.getElementById('addressModal');
        if (e.target === modal) closeAddressModal();
    });

    document.addEventListener('DOMContentLoaded', () => {
        // SSRë¡œ ì´ë¯¸ ë Œë”ëœ ê²½ìš°ì—ë„ í´ë¼ì´ì–¸íŠ¸ ìƒˆë¡œê³ ì¹¨ìš© ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ë™ê¸°í™”
        loadAddressList();
    });
</script>
</body>
</html> 