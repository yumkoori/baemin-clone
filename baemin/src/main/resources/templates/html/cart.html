<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{html/base :: layout(~{::title}, ~{::content})}">
<head>
    <title>ì¥ë°”êµ¬ë‹ˆ - ë°°ë‹¬ì˜ ë¯¼ì¡±</title>
</head>
<body>
    <div th:fragment="content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>ğŸ›’ ì¥ë°”êµ¬ë‹ˆ</h2>
            <button id="clearCartBtn" class="btn btn-secondary btn-small">ì „ì²´ ë¹„ìš°ê¸°</button>
        </div>

        <!-- ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆì„ ë•Œ -->
        <div id="emptyCart" class="card text-center" style="display: none;">
            <div style="padding: 60px 20px;">
                <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ›’</div>
                <h3 class="mb-2">ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤</h3>
                <p class="text-muted mb-3">ë§›ìˆëŠ” ìŒì‹ì„ ë‹´ì•„ë³´ì„¸ìš”!</p>
                <a href="/" class="btn btn-primary">ìŒì‹ ì£¼ë¬¸í•˜ê¸°</a>
            </div>
        </div>

        <!-- ì¥ë°”êµ¬ë‹ˆ ë‚´ìš© -->
        <div id="cartContent">
            <!-- ê°€ê²Œ ì •ë³´ -->
            <div id="storeInfo" class="card mb-3">
                <div class="card-header">
                    <h4 id="storeName" class="card-title">ê°€ê²Œëª…</h4>
                </div>
            </div>

            <!-- ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œë“¤ -->
            <div id="cartItems" class="card mb-3">
                <div class="card-header">
                    <h5 class="card-title">ì£¼ë¬¸ ë©”ë‰´</h5>
                </div>
                <div id="itemsList">
                    <!-- ë™ì ìœ¼ë¡œ ì•„ì´í…œë“¤ì´ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <!-- ì£¼ë¬¸ ê¸ˆì•¡ ì •ë³´ -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="card-title">ê²°ì œ ì •ë³´</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>ì£¼ë¬¸ ê¸ˆì•¡</span>
                        <span id="totalAmount">0ì›</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>ë°°ë‹¬íŒ</span>
                        <span id="deliveryFee">0ì›</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2 text-muted" id="discountRow" style="display: none;">
                        <span>í• ì¸ ê¸ˆì•¡</span>
                        <span id="discountAmount">-0ì›</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <strong>ì´ ê²°ì œ ê¸ˆì•¡</strong>
                        <strong id="finalAmount" class="text-primary" style="font-size: 1.2rem;">0ì›</strong>
                    </div>
                </div>
            </div>

            <!-- ìµœì†Œ ì£¼ë¬¸ ê¸ˆì•¡ ì•ˆë‚´ -->
            <div id="minOrderAlert" class="card mb-3" style="display: none; border-left: 4px solid #dc3545;">
                <div class="card-body">
                    <div class="text-danger">
                        <strong>âš ï¸ ìµœì†Œ ì£¼ë¬¸ ê¸ˆì•¡ ë¯¸ë‹¬</strong>
                        <p class="mb-0">ìµœì†Œ ì£¼ë¬¸ ê¸ˆì•¡ì€ <span id="minOrderAmount">0ì›</span>ì…ë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>

            <!-- ì£¼ë¬¸í•˜ê¸° í¼ -->
            <div class="text-center">
                <form id="orderForm" action="/api/orders/form" method="POST" style="display: inline-block; width: 100%;">
                    <!-- ê²°ì œ ë‹´ë‹¹ íŒ€ì›ì´ í•„ìš”í•œ ë°ì´í„°ë¥¼ hidden inputìœ¼ë¡œ ì „ë‹¬ -->
                    <input type="hidden" id="formCartId" name="cartId" value="">
                    <input type="hidden" id="formStoreId" name="storeId" value="">
                    <input type="hidden" id="formStoreName" name="storeName" value="">
                    <input type="hidden" id="formTotalAmount" name="totalAmount" value="">
                    <input type="hidden" id="formDeliveryFee" name="deliveryFee" value="">
                    <input type="hidden" id="formDiscountAmount" name="discountAmount" value="">
                    <input type="hidden" id="formFinalAmount" name="finalAmount" value="">
                    <input type="hidden" id="formMinOrderAmount" name="minOrderAmount" value="">
                    <input type="hidden" id="formIsOrderable" name="isOrderable" value="">
                    <input type="hidden" id="formCartItemOptionIds" name="cartItemOptionIds" value="">
                    
                    <button type="submit" id="orderBtn" class="btn btn-primary" style="width: 100%; padding: 16px; font-size: 1.2rem;" disabled>
                        ì£¼ë¬¸í•˜ê¸°
                    </button>
                </form>
            </div>
        </div>

        <!-- ì•„ì´í…œ í…œí”Œë¦¿ -->
        <template id="cartItemTemplate">
            <div class="cart-item" data-item-id="">
                <div class="d-flex justify-content-between align-items-start p-3" style="border-bottom: 1px solid #eee;">
                    <div class="flex-grow-1">
                        <h6 class="item-name mb-1"></h6>
                        <div class="item-options text-muted mb-2"></div>
                        <div class="d-flex align-items-center">
                            <button class="btn-quantity minus" style="width: 32px; height: 32px; border: 1px solid #ddd; background: white; border-radius: 4px;">-</button>
                            <span class="quantity mx-3" style="min-width: 20px; text-align: center;">1</span>
                            <button class="btn-quantity plus" style="width: 32px; height: 32px; border: 1px solid #ddd; background: white; border-radius: 4px;">+</button>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="item-price mb-2"></div>
                        <div class="mb-2">
                            <button class="btn btn-secondary btn-small edit-options">ì˜µì…˜ ë³€ê²½</button>
                        </div>
                        <button class="btn btn-danger btn-small delete-item">ì‚­ì œ</button>
                    </div>
                </div>
            </div>
        </template>

        <!-- ì˜µì…˜ ë³€ê²½ ëª¨ë‹¬ -->
        <div class="modal fade" id="editOptionsModal" tabindex="-1" style="display: none;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ì˜µì…˜ ë³€ê²½</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div id="optionsForm">
                            <!-- ë™ì ìœ¼ë¡œ ì˜µì…˜ë“¤ì´ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                        <button type="button" class="btn btn-primary" id="saveOptionsBtn">ë³€ê²½ ì €ì¥</button>
                    </div>
                </div>
            </div>
        </div>

        <style>
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1050;
        }
        
        .modal.show {
            display: block !important;
        }
        
        .modal-dialog {
            position: relative;
            width: auto;
            margin: 1.75rem auto;
            max-width: 500px;
        }
        
        .modal-content {
            position: relative;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 0;
        }
        
        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 500;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        
        .btn-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
        }
        
        body.modal-open {
            overflow: hidden;
        }
        </style>

        <script>
            // ì¥ë°”êµ¬ë‹ˆ í˜ì´ì§€ ìŠ¤í¬ë¦½íŠ¸
            class CartPage {
                constructor() {
                    this.currentEditingCartItemId = null;
                    this.currentItemData = null;
                    this.init();
                }

                async init() {
                    await this.loadCart();
                    this.bindEvents();
                }

                async loadCart() {
                    try {
                        utils.showLoading(true);
                        const response = await cartApi.getCart();
                        
                        if (response.success) {
                            this.renderCart(response.data);
                        } else {
                            this.showEmptyCart();
                        }
                    } catch (error) {
                        console.error('ì¥ë°”êµ¬ë‹ˆ ë¡œë“œ ì‹¤íŒ¨:', error);
                        this.showEmptyCart();
                        utils.showAlert('ì¥ë°”êµ¬ë‹ˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    } finally {
                        utils.showLoading(false);
                    }
                }

                renderCart(cartData) {
                    if (!cartData || !cartData.items || cartData.items.length === 0) {
                        this.showEmptyCart();
                        return;
                    }

                    document.getElementById('emptyCart').style.display = 'none';
                    document.getElementById('cartContent').style.display = 'block';

                    // ê°€ê²Œ ì •ë³´ í‘œì‹œ
                    document.getElementById('storeName').textContent = cartData.storeName;

                    // ì•„ì´í…œë“¤ ë Œë”ë§
                    const itemsList = document.getElementById('itemsList');
                    itemsList.innerHTML = '';

                    cartData.items.forEach(item => {
                        const itemElement = this.createCartItemElement(item);
                        itemsList.appendChild(itemElement);
                    });

                    // ê°€ê²© ì •ë³´ ì—…ë°ì´íŠ¸
                    this.updatePriceInfo(cartData);
                }

                createCartItemElement(item) {
                    const template = document.getElementById('cartItemTemplate');
                    const itemElement = template.content.cloneNode(true);
                    
                    const container = itemElement.querySelector('.cart-item');
                    container.setAttribute('data-item-id', item.cartItemId);
                    
                    itemElement.querySelector('.item-name').textContent = item.menuName;
                    
                    // ì˜µì…˜ í‘œì‹œ
                    const optionsText = item.options.map(opt => `${opt.optionName}: ${opt.optionValue}`).join(', ');
                    itemElement.querySelector('.item-options').textContent = optionsText || 'ì˜µì…˜ ì—†ìŒ';
                    
                    itemElement.querySelector('.quantity').textContent = item.quantity;
                    itemElement.querySelector('.item-price').textContent = utils.formatPrice(item.totalPrice);

                    return itemElement;
                }

                updatePriceInfo(cartData) {
                    // í™”ë©´ í‘œì‹œìš©
                    document.getElementById('totalAmount').textContent = utils.formatPrice(cartData.totalAmount);
                    document.getElementById('deliveryFee').textContent = utils.formatPrice(cartData.deliveryFee);
                    document.getElementById('finalAmount').textContent = utils.formatPrice(cartData.finalAmount);
                    
                    if (cartData.discountAmount > 0) {
                        document.getElementById('discountRow').style.display = 'flex';
                        document.getElementById('discountAmount').textContent = '-' + utils.formatPrice(cartData.discountAmount);
                    }

                    // â­ Form ë°ì´í„° ì—…ë°ì´íŠ¸ (ê²°ì œ íŒ€ì›ì´ ë°›ì„ ë°ì´í„°)
                    document.getElementById('formCartId').value = cartData.cartId || '';
                    document.getElementById('formStoreId').value = cartData.storeId || '';
                    document.getElementById('formStoreName').value = cartData.storeName || '';
                    document.getElementById('formTotalAmount').value = cartData.totalAmount || 0;
                    document.getElementById('formDeliveryFee').value = cartData.deliveryFee || 0;
                    document.getElementById('formDiscountAmount').value = cartData.discountAmount || 0;
                    document.getElementById('formFinalAmount').value = cartData.finalAmount || 0;
                    document.getElementById('formMinOrderAmount').value = cartData.minOrderAmount || 0;
                    document.getElementById('formIsOrderable').value = cartData.isOrderable || false;
                    
                    // ì¹´íŠ¸ ì•„ì´í…œ ì˜µì…˜ IDë“¤ ìˆ˜ì§‘
                    const cartItemOptionIds = [];
                    if (cartData.items) {
                        cartData.items.forEach(item => {
                            if (item.options && item.options.length > 0) {
                                item.options.forEach(option => {
                                    if (option.cartItemOptionId) {
                                        cartItemOptionIds.push(option.cartItemOptionId);
                                    }
                                });
                            }
                        });
                    }
                    document.getElementById('formCartItemOptionIds').value = JSON.stringify(cartItemOptionIds);

                    // ìµœì†Œ ì£¼ë¬¸ ê¸ˆì•¡ ì²´í¬
                    const minOrderAlert = document.getElementById('minOrderAlert');
                    const orderBtn = document.getElementById('orderBtn');
                    
                    if (!cartData.isOrderable) {
                        minOrderAlert.style.display = 'block';
                        document.getElementById('minOrderAmount').textContent = utils.formatPrice(cartData.minOrderAmount);
                        orderBtn.disabled = true;
                        orderBtn.textContent = `ìµœì†Œ ì£¼ë¬¸ ê¸ˆì•¡ ${utils.formatPrice(cartData.minOrderAmount)}`;
                    } else {
                        minOrderAlert.style.display = 'none';
                        orderBtn.disabled = false;
                        orderBtn.textContent = `${utils.formatPrice(cartData.finalAmount)} ì£¼ë¬¸í•˜ê¸°`;
                    }
                }

                showEmptyCart() {
                    document.getElementById('emptyCart').style.display = 'block';
                    document.getElementById('cartContent').style.display = 'none';
                }

                bindEvents() {
                    // ìˆ˜ëŸ‰ ë³€ê²½ ì´ë²¤íŠ¸
                    document.addEventListener('click', async (e) => {
                        if (e.target.classList.contains('btn-quantity')) {
                            const cartItem = e.target.closest('.cart-item');
                            const cartItemId = cartItem.getAttribute('data-item-id');
                            const quantitySpan = cartItem.querySelector('.quantity');
                            let currentQuantity = parseInt(quantitySpan.textContent);

                            if (e.target.classList.contains('plus')) {
                                currentQuantity++;
                            } else if (e.target.classList.contains('minus')) {
                                if (currentQuantity > 1) {
                                    currentQuantity--;
                                } else {
                                    return; // 1 ë¯¸ë§Œìœ¼ë¡œ ë‚´ë ¤ê°€ì§€ ì•ŠìŒ
                                }
                            }

                            await this.updateQuantity(cartItemId, currentQuantity);
                        }
                    });

                    // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
                    document.addEventListener('click', async (e) => {
                        if (e.target.classList.contains('delete-item')) {
                            const cartItem = e.target.closest('.cart-item');
                            const cartItemId = cartItem.getAttribute('data-item-id');
                            
                            if (confirm('ì´ ë©”ë‰´ë¥¼ ì¥ë°”êµ¬ë‹ˆì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                await this.deleteItem(cartItemId);
                            }
                        }
                    });

                    // ì „ì²´ ë¹„ìš°ê¸° ë²„íŠ¼
                    document.getElementById('clearCartBtn').addEventListener('click', async () => {
                        if (confirm('ì¥ë°”êµ¬ë‹ˆë¥¼ ì „ì²´ ë¹„ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                            await this.clearCart();
                        }
                    });

                    // ì˜µì…˜ ë³€ê²½ ë²„íŠ¼ ì´ë²¤íŠ¸
                    document.addEventListener('click', async (e) => {
                        if (e.target.classList.contains('edit-options')) {
                            const cartItem = e.target.closest('.cart-item');
                            const cartItemId = cartItem.getAttribute('data-item-id');
                            
                            // í˜„ì¬ ì¥ë°”êµ¬ë‹ˆ ë°ì´í„°ì—ì„œ í•´ë‹¹ ì•„ì´í…œ ì°¾ê¸°
                            const response = await cartApi.getCart();
                            if (response.success) {
                                const item = response.data.items.find(item => item.cartItemId == cartItemId);
                                if (item) {
                                    this.showEditOptionsModal(cartItemId, item);
                                }
                            }
                        }
                    });

                    // ì˜µì…˜ ì €ì¥ ë²„íŠ¼
                    document.getElementById('saveOptionsBtn').addEventListener('click', async () => {
                        await this.saveOptionsChanges();
                    });

                    // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ë“¤
                    document.addEventListener('click', (e) => {
                        if (e.target.classList.contains('btn-close') || 
                            (e.target.classList.contains('btn-secondary') && e.target.getAttribute('data-bs-dismiss') === 'modal')) {
                            const modal = document.getElementById('editOptionsModal');
                            modal.style.display = 'none';
                            modal.classList.remove('show');
                            document.body.classList.remove('modal-open');
                        }
                    });

                    // ì£¼ë¬¸í•˜ê¸° ë²„íŠ¼ - í¼ ì œì¶œë¡œ ë³€ê²½
                    document.getElementById('orderBtn').addEventListener('click', (e) => {
                        e.preventDefault();
                        const form = document.getElementById('orderForm');
                        const btn = document.getElementById('orderBtn');
                        if (form && btn && !btn.disabled) {
                            form.submit();
                        }
                    });
                }

                async updateQuantity(cartItemId, quantity) {
                    try {
                        utils.showLoading(true);
                        const response = await cartApi.updateItem(cartItemId, { quantity });
                        
                        if (response.success) {
                            await this.loadCart(); // ì¥ë°”êµ¬ë‹ˆ ìƒˆë¡œê³ ì¹¨
                            utils.showAlert('ìˆ˜ëŸ‰ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                        }
                    } catch (error) {
                        console.error('ìˆ˜ëŸ‰ ë³€ê²½ ì‹¤íŒ¨:', error);
                        utils.showAlert('ìˆ˜ëŸ‰ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    } finally {
                        utils.showLoading(false);
                    }
                }

                async deleteItem(cartItemId) {
                    try {
                        utils.showLoading(true);
                        const response = await cartApi.deleteItem(cartItemId);
                        
                        if (response.success) {
                            await this.loadCart(); // ì¥ë°”êµ¬ë‹ˆ ìƒˆë¡œê³ ì¹¨
                            utils.showAlert('ë©”ë‰´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                        }
                    } catch (error) {
                        console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
                        utils.showAlert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    } finally {
                        utils.showLoading(false);
                    }
                }

                async clearCart() {
                    try {
                        utils.showLoading(true);
                        const response = await cartApi.clearCart();
                        
                        if (response.success) {
                            this.showEmptyCart();
                            utils.showAlert('ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì›Œì¡ŒìŠµë‹ˆë‹¤.', 'success');
                        }
                    } catch (error) {
                        console.error('ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê¸° ì‹¤íŒ¨:', error);
                        utils.showAlert('ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    } finally {
                        utils.showLoading(false);
                    }
                }

                async showEditOptionsModal(cartItemId, itemData) {
                    this.currentEditingCartItemId = cartItemId;
                    this.currentItemData = itemData;
                    
                    try {
                        utils.showLoading(true);
                        
                        // í•´ë‹¹ ë©”ë‰´ì˜ ì „ì²´ ì˜µì…˜ ëª©ë¡ ì¡°íšŒ
                        console.log('ë©”ë‰´ ì˜µì…˜ ì¡°íšŒ ì‹œì‘ - menuId:', itemData.menuId);
                        const menuOptionsResponse = await menuApi.getMenuOptions(itemData.menuId);
                        console.log('ë©”ë‰´ ì˜µì…˜ ì‘ë‹µ:', menuOptionsResponse);
                        
                        if (menuOptionsResponse.success) {
                            console.log('ë©”ë‰´ ì˜µì…˜ ë°ì´í„°:', menuOptionsResponse.data);
                            this.renderOptionsForm(menuOptionsResponse.data, itemData.options);
                            
                            // ëª¨ë‹¬ í‘œì‹œ (ìˆœìˆ˜ JavaScript)
                            const modal = document.getElementById('editOptionsModal');
                            modal.style.display = 'block';
                            modal.classList.add('show');
                            document.body.classList.add('modal-open');
                        } else {
                            console.error('ë©”ë‰´ ì˜µì…˜ ì¡°íšŒ ì‹¤íŒ¨ - ì‘ë‹µ:', menuOptionsResponse);
                            utils.showAlert('ë©”ë‰´ ì˜µì…˜ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                        }
                    } catch (error) {
                        console.error('ë©”ë‰´ ì˜µì…˜ ì¡°íšŒ ì‹¤íŒ¨:', error);
                        utils.showAlert('ë©”ë‰´ ì˜µì…˜ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    } finally {
                        utils.showLoading(false);
                    }
                }

                renderOptionsForm(availableOptions, currentOptions) {
                    const optionsForm = document.getElementById('optionsForm');
                    optionsForm.innerHTML = '';
                    
                    console.log('ë Œë”ë§í•  ì˜µì…˜ ê°œìˆ˜:', availableOptions.length);
                    
                    availableOptions.forEach((option, index) => {
                        console.log(`ì˜µì…˜ ${index}:`, option);
                        console.log(`ì˜µì…˜ ${index}ì˜ optionValues:`, option.optionValues);
                        // í˜„ì¬ ì„ íƒëœ ê°’ ì°¾ê¸° (cart responseì—ì„œ ì˜¨ menuOptionValueId ì‚¬ìš©)
                        const currentOption = currentOptions.find(curr => curr.optionId === option.optionId);
                        const currentValueId = currentOption ? currentOption.menuOptionValueId : null;
                        
                        let optionHtml = `
                            <div class="mb-3">
                                <label class="form-label">
                                    ${option.optionName}
                                    ${option.isRequired ? '<span class="text-danger">*</span>' : ''}
                                    ${option.additionalPrice > 0 ? `<span class="text-muted">(+${utils.formatPrice(option.additionalPrice)})</span>` : ''}
                                </label>
                                <input type="hidden" name="optionId_${index}" value="${option.optionId}">
                        `;
                        
                        if (option.optionValues && option.optionValues.length > 0) {
                            // ë“œë¡­ë‹¤ìš´ìœ¼ë¡œ ì„ íƒ
                            optionHtml += `
                                <select class="form-control" name="optionValue_${index}" ${option.isRequired ? 'required' : ''}>
                                    ${!option.isRequired ? '<option value="">ì„ íƒ ì•ˆí•¨</option>' : ''}
                            `;
                            
                            option.optionValues.forEach(valueObj => {
                                // valueObjê°€ ê°ì²´ì¸ì§€ ë¬¸ìì—´ì¸ì§€ í™•ì¸ (í•˜ìœ„í˜¸í™˜ì„±)
                                const value = typeof valueObj === 'object' ? valueObj.optionValue : valueObj;
                                const optionValueId = typeof valueObj === 'object' ? valueObj.optionValueId : null;
                                const additionalPrice = typeof valueObj === 'object' ? valueObj.additionalPrice : 0;
                                const selected = optionValueId === currentValueId ? 'selected' : '';
                                
                                // ì¶”ê°€ ê¸ˆì•¡ì´ ìˆìœ¼ë©´ í‘œì‹œ
                                const priceText = additionalPrice > 0 ? ` (+${utils.formatPrice(additionalPrice)})` : '';
                                // value ì†ì„±ì—ëŠ” optionValueIdë¥¼, í‘œì‹œ í…ìŠ¤íŠ¸ì—ëŠ” optionValueë¥¼ ì‚¬ìš©
                                optionHtml += `<option value="${optionValueId}" ${selected}>${value}${priceText}</option>`;
                            });
                            
                            optionHtml += '</select>';
                        } else {
                            // optionValuesê°€ ì—†ëŠ” ê²½ìš° - DBì— ì˜µì…˜ ê°’ì´ ì •ì˜ë˜ì§€ ì•ŠìŒ
                            optionHtml += `
                                <div class="alert alert-warning">
                                    ì´ ì˜µì…˜ì— ëŒ€í•œ ì„ íƒ ê°€ëŠ¥í•œ ê°’ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br>
                                    ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.
                                </div>
                                <input type="hidden" name="optionValue_${index}" value="">
                            `;
                        }
                        
                        optionHtml += '</div>';
                        optionsForm.insertAdjacentHTML('beforeend', optionHtml);
                    });
                }

                async saveOptionsChanges() {
                    if (!this.currentEditingCartItemId) return;
                    
                    try {
                        utils.showLoading(true);
                        
                        const optionsForm = document.getElementById('optionsForm');
                        
                        // ìˆ˜ë™ í¼ ê²€ì¦ - í•„ìˆ˜ ì˜µì…˜ë“¤ì´ ì„ íƒë˜ì—ˆëŠ”ì§€ í™•ì¸
                        const requiredSelects = optionsForm.querySelectorAll('select[required]');
                        let isValid = true;
                        let firstInvalidElement = null;
                        
                        for (const select of requiredSelects) {
                            if (!select.value || select.value.trim() === '') {
                                isValid = false;
                                if (!firstInvalidElement) {
                                    firstInvalidElement = select;
                                }
                                // ë¹¨ê°„ í…Œë‘ë¦¬ í‘œì‹œ
                                select.style.border = '2px solid #dc3545';
                            } else {
                                // ì •ìƒ í…Œë‘ë¦¬ë¡œ ë³µì›
                                select.style.border = '';
                            }
                        }
                        
                        if (!isValid) {
                            if (firstInvalidElement) {
                                firstInvalidElement.focus();
                            }
                            utils.showAlert('í•„ìˆ˜ ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                            utils.showLoading(false);
                            return;
                        }
                        
                        // ìˆ˜ë™ìœ¼ë¡œ í¼ ë°ì´í„° ìˆ˜ì§‘
                        const hiddenInputs = optionsForm.querySelectorAll('input[type="hidden"]');
                        const selects = optionsForm.querySelectorAll('select');
                        
                        // ìƒˆë¡œìš´ ì˜µì…˜ ë°ì´í„° êµ¬ì„±
                        const newOptions = [];
                        
                        // optionIdì™€ optionValueë¥¼ ë§¤ì¹­í•˜ì—¬ ìˆ˜ì§‘
                        for (let i = 0; i < hiddenInputs.length; i++) {
                            const hiddenInput = hiddenInputs[i];
                            if (hiddenInput.name.startsWith('optionId_')) {
                                const index = hiddenInput.name.split('_')[1];
                                const optionId = hiddenInput.value;
                                const selectElement = optionsForm.querySelector(`select[name="optionValue_${index}"]`);
                                
                                if (selectElement && selectElement.value && selectElement.value.trim() && selectElement.value !== 'null') {
                                    const menuOptionValueId = parseInt(selectElement.value.trim());
                                    if (!isNaN(menuOptionValueId)) {
                                        newOptions.push({
                                            optionId: parseInt(optionId),
                                            menuOptionValueId: menuOptionValueId
                                        });
                                    }
                                }
                            }
                        }
                        
                        // API í˜¸ì¶œ
                        const response = await cartApi.updateItemOptions(this.currentEditingCartItemId, newOptions);
                        
                        if (response.success) {
                            // ëª¨ë‹¬ ë‹«ê¸° (ìˆœìˆ˜ JavaScript)
                            const modal = document.getElementById('editOptionsModal');
                            modal.style.display = 'none';
                            modal.classList.remove('show');
                            document.body.classList.remove('modal-open');
                            
                            // ì¥ë°”êµ¬ë‹ˆ ìƒˆë¡œê³ ì¹¨
                            await this.loadCart();
                            utils.showAlert('ì˜µì…˜ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                        }
                    } catch (error) {
                        console.error('ì˜µì…˜ ë³€ê²½ ì‹¤íŒ¨:', error);
                        utils.showAlert('ì˜µì…˜ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    } finally {
                        utils.showLoading(false);
                    }
                }
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
            document.addEventListener('DOMContentLoaded', () => {
                new CartPage();
            });
        </script>
    </div>
</body>
</html>