<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆì´ë°°ë¯¼ - ë‚´ ì •ë³´ ìˆ˜ì •</title>
    <link rel="stylesheet" href="/css/mypage.css">
</head>
<body>
<div class="baemin-page" id="profileWrap" th:data-email="${user?.email}">
    <header class="appbar">
        <a class="icon-btn back" href="/api/mypage" aria-label="ë’¤ë¡œ">â†</a>
        <h1 class="appbar-title">ë§ˆì´ë°°ë¯¼</h1>
    </header>

    <main class="content">
        <section class="view active">
            <div class="page-title">ë‚´ ì •ë³´ ìˆ˜ì •</div>
            <div class="profile-edit">
                <div class="avatar large">
                    <img id="profileImg"
                         th:src="${(user?.profileImageUrl) ?: 'https://via.placeholder.com/96x96/EEE/888?text=ğŸ‘¤'}"
                         alt="í”„ë¡œí•„ ì´ë¯¸ì§€">
                    <button class="camera-btn" onclick="openImageUpload()">ğŸ“·</button>
                </div>

                <ul class="list">
                    <li class="list-item" id="nicknameItem" role="button">
                        <span class="label">ë‹‰ë„¤ì„</span>
                        <span class="value"
                              th:text="${#strings.isEmpty(user?.nickname) ? 'ë‹‰ë„¤ì„' : user.nickname}">ë‹‰ë„¤ì„
                        </span>
                        <span class="chevron">â€º</span>
                    </li>
                    <li class="list-item">
                        <span class="label">ì´ë¦„</span>
                        <span class="value"
                              th:text="${#strings.isEmpty(user?.realName) ? 'ì´ë¦„' : user.realName}">ì´ë¦„</span>
                        <span class="chevron">â€º</span>
                    </li>
                    <li class="list-item">
                        <span class="label">ëŒ€í‘œ ì´ë©”ì¼</span>
                        <span class="value"
                              th:text="${#strings.isEmpty(user?.email) ? 'ì´ë©”ì¼' : user.email}">ì´ë©”ì¼</span>
                        <span class="chevron">â€º</span>
                    </li>
                    <li class="list-item muted" role="button">
                        <span class="label">íœ´ëŒ€í° ë²ˆí˜¸ ë³€ê²½</span>
                        <span class="chevron">â€º</span>
                    </li>
                </ul>

                <ul class="list">
                    <li class="list-item">
                        <span class="label">ë¡œê·¸ì¸ ê¸°ê¸° ê´€ë¦¬</span>
                        <span class="helper">ë‚´ ì•„ì´ë””ë¡œ ë¡œê·¸ì¸ ëœ ê¸°ê¸°ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆì–´ìš”</span>
                        <span class="chevron">â€º</span>
                    </li>
                </ul>

                <ul class="list">
                    <li class="list-item">
                        <span class="label">ì—°ë™ëœ ì†Œì…œ ê³„ì •</span>
                        <span class="value">ğŸ’¬</span>
                        <span class="chevron">â€º</span>
                    </li>
                </ul>

                <div class="bottom-links">
                    <button class="text-btn" onclick="logoutWithService()">ë¡œê·¸ì•„ì›ƒ</button>
                    <span class="divider">|</span>
                    <button class="text-btn danger" onclick="deleteAccount()">íšŒì›íƒˆí‡´</button>
                </div>
            </div>
        </section>
    </main>

    <nav class="bottombar">
        <a class="bottom-item" href="/api/main">
            <span>ğŸ </span>
            <span>í™ˆ</span>
        </a>
        <a class="bottom-item" href="#">
            <span>ğŸ›ï¸</span>
            <span>ì¥ë³´ê¸°Â·ì‡¼í•‘</span>
        </a>
        <a class="bottom-item" href="#">
            <span>â¤</span>
            <span>ì°œ</span>
        </a>
        <a class="bottom-item" href="#">
            <span>ğŸ§¾</span>
            <span>ì£¼ë¬¸ë‚´ì—­</span>
        </a>
        <a class="bottom-item active" href="/api/mypage">
            <span>ğŸ™‚</span>
            <span>ë§ˆì´ë°°ë¯¼</span>
        </a>
    </nav>
</div>

<input type="file" id="profileImageInput"
       accept="image/jpeg,image/png"
       style="display:none"
       onchange="uploadProfileImage()">

<script>
    function openImageUpload() {
        document.getElementById('profileImageInput').click();
    }

    async function uploadProfileImage() {
        const fileInput = document.getElementById('profileImageInput');
        const file = fileInput.files[0];
        if (!file) return;

        // ê¸°ë³¸ ê²€ì¦
        if (file.size > 5 * 1024 * 1024) { alert('íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return; }
        const allowed = ['image/jpeg','image/jpg','image/png'];
        if (!allowed.includes(file.type)) { alert('JPG/PNG í˜•ì‹ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return; }

        const profileImg = document.getElementById('profileImg');
        const originalSrc = profileImg.src;
        profileImg.style.opacity = '0.5';

        // API í˜¸ì¶œ ì¤€ë¹„
        const formData = new FormData();
        formData.append('profileImage', file); // â† ì„œë²„ @RequestParam("profileImage") ì™€ ì¼ì¹˜í•´ì•¼ í•¨

        const email = document.getElementById('profileWrap').dataset.email;

        try {
            const res = await fetch(`/api/users/${encodeURIComponent(email)}/profile-image`, {
                method: 'POST',
                credentials: 'include',
                body: formData
            });
            const result = await res.json();
            if (result.resultCode === 200 || res.ok) {
                const newUrl = (result.data?.imageUrl || result.url) + '?t=' + Date.now(); // ìºì‹œ ìš°íšŒ
                profileImg.src = newUrl;
            } else {
                alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (result.message || res.status));
                profileImg.src = originalSrc;
            }
        } catch (e) {
            console.error(e);
            alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            profileImg.src = originalSrc;
        } finally {
            profileImg.style.opacity = '1';
            fileInput.value = '';
        }
    }

    // ë‹‰ë„¤ì„ í¸ì§‘ í˜ì´ì§€ë¡œ ì´ë™
    (function(){
        const el = document.getElementById('nicknameItem');
        if (el) {
            el.addEventListener('click', () => {
                window.location.href = '/api/mypage/profile/nickname';
            });
        }
    })();

    function logoutWithService() {
        if (confirm('ì¹´ì¹´ì˜¤ê³„ì •ê³¼ í•¨ê»˜ ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            const baseOrigin = window.location.origin;
            const logoutRedirect = baseOrigin + '/api/logout';
            const kakaoLogoutUrl = "https://kauth.kakao.com/oauth/logout" +
                "?client_id=9332367d804b05aa4921d0ddd1c788cb" +
                `&logout_redirect_uri=${encodeURIComponent(logoutRedirect)}`;
            window.location.href = kakaoLogoutUrl;
        }
    }

    async function deleteAccount() {
        if (!confirm('ì •ë§ë¡œ íšŒì› íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        if (!confirm('ë§ˆì§€ë§‰ í™•ì¸ì…ë‹ˆë‹¤. ì •ë§ë¡œ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try {
            const res = await fetch('/api/user/account', { method: 'DELETE', credentials: 'include' });
            const result = await res.json();
            if (result.resultCode === 200) window.location.href = '/';
            else alert('íšŒì› íƒˆí‡´ ì‹¤íŒ¨: ' + result.message);
        } catch (e) { alert('íšŒì› íƒˆí‡´ ì¤‘ ì˜¤ë¥˜'); }
    }
</script>
</body>
</html>

