<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>주문하기</title>
    <link rel="stylesheet" th:href="@{/css/order.css}" />
    <!-- PortOne 결제 SDK (V2) 로드 -->
    <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
    <script defer th:src="@{/js/order.js}"></script>
    </head>
<body>
<div class="container"
     th:if="${cartData}"
     th:attr="data-price=${cartData.totalAmount},data-delivery=${cartData.deliveryFee},data-discount=${cartData.discountAmount},data-total=${cartData.finalAmount}">
    <!-- 상단 타이틀 바 -->
    <div class="topbar">
        <div class="back" onclick="history.back()">‹</div>
        <div class="title">주문하기</div>
        <div class="spacer"></div>
    </div>

    <!-- 배송 타입/도착 예상 -->
    <section class="delivery-type">
        <div>
            <span class="badge blue">배달</span>
            <span class="text">로 받을게요</span>
        </div>
        <div class="eta">15~30분 후 도착</div>
    </section>

    <!-- 배달주소 -->
    <section class="card clickable">
        <div class="row between">
            <div>
                <div class="label">배달주소</div>
                <div class="addr">서울특별시 강남구 테헤란로 132 8층</div>
                <div class="addr sub">쌍용교육센터</div>
            </div>
            <div class="chev">›</div>
        </div>
    </section>

    <!-- 라이더 요청사항 -->
    <section class="card clickable">
        <div class="row between">
            <div>
                <div class="label">라이더 요청사항</div>
                <div class="muted">문 앞에 두고 벨 눌러주세요</div>
            </div>
            <div class="chev">›</div>
        </div>
    </section>

    <!-- 내 연락처 -->
    <section class="card clickable">
        <div class="row between">
            <div>
                <div class="label">내 연락처</div>
                <div class="row gap">
                    <div>010-3261-4322</div>
                    <span class="chip">안심결제</span>
                    <span class="chip">안심번호</span>
                </div>
            </div>
            <div class="chev">›</div>
        </div>
    </section>

    <!-- 가게 요청사항 -->
    <section class="card clickable">
        <div class="row between">
            <div>
                <div class="label">가게 요청사항</div>
                <div class="muted">요청사항 없음</div>
                <div class="hint green">수저·포크 안 받기, 기본반찬 받기</div>
            </div>
            <a class="link">요청 입력</a>
        </div>
    </section>

    <!-- 결제수단 -->
    <section class="card">
        <div class="row between header-row">
            <div class="label">결제수단</div>
            <a class="link">선택</a>
        </div>
        <ul class="payments">
            <li>
                <label>
                    <input type="radio" name="pay" checked />
                    <span class="pay-name">신용/체크카드</span>
                </label>
            </li>
            <li>
                <label>
                    <input type="radio" name="pay" />
                    <span class="pay-name">토스페이</span>
                    <span class="note">배민 첫결제 1,000원</span>
                </label>
            </li>
            <li>
                <label>
                    <input type="radio" name="pay" />
                    <span class="pay-name">카카오페이</span>
                </label>
            </li>
            <li>
                <label>
                    <input type="radio" name="pay" />
                    <span class="pay-name">기타 결제수단</span>
                </label>
            </li>
        </ul>
        <ul class="notice">
            <li>민생형 특화소비쿠폰 [기타 결제수단 &gt; 만나서 카드결제 선택 시 사용 가능</li>
            <li>배민에서 토스페이로 첫 결제 시, 1만원 이상 1천원 즉시 할인 (~8/31)</li>
            <li>카드 일반결제 혜택 보기</li>
        </ul>
    </section>

    <!-- 프로모션 배너 -->
    <section class="promo card clickable">
        <div class="row between">
            <div class="row gap">
                <div class="promo-thumb">B회원</div>
                <div>
                    <div class="promo-title">배민클럽 회원이면 받을 수 있어요!</div>
                    <div class="promo-sub">결제금액의 총 10% 돌려드려요.</div>
                </div>
            </div>
            <button class="outline">할인 받기</button>
        </div>
    </section>

    <!-- 쿠폰/선물함/포인트 -->
    <section class="card clickable" onclick="toggleCouponModal()">
        <div class="row between">
            <div class="label">할인쿠폰</div>
            <div class="muted" th:text="${couponCount} + '장 보유'">0장 보유</div>
        </div>
        <div class="row between">
            <div class="muted" id="selectedCouponText" th:if="${couponCount == 0}">사용 가능한 쿠폰이 없어요</div>
            <div class="muted" id="selectedCouponText" th:if="${couponCount > 0}">쿠폰을 선택해주세요</div>
            <div class="chev">›</div>
        </div>
    </section>

    <section class="card clickable mini">
        <div class="row between"><div class="label">선물함</div><div class="muted">0원 보유</div></div>
    </section>

    <section class="card clickable mini">
        <div class="row between"><div class="label">포인트</div><div class="muted">0원 보유</div></div>
    </section>

    <!-- 정산 -->
    <section class="card">
        <div class="summary">
            <div th:if="${cartData}">
                <div class="line">
                    <span>가게명</span>
                    <strong th:text="${cartData.storeName}"></strong>
                </div>
                <div th:each="item : ${cartData.items}">
                    <div class="line">
                        <span th:text="${item.menuName}"></span>
                        <strong th:text="${#numbers.formatInteger(item.totalPrice, 3, 'COMMA')} + '원'"></strong>
                    </div>
                    <div class="line" th:each="option : ${item.options}" style="margin-left: 10px; font-size: 0.9em;">
                        <span th:text="${option.optionName} + ': ' + ${option.optionValue}"></span>
                        <span th:if="${option.additionalPrice > 0}" th:text="'+' + ${#numbers.formatInteger(option.additionalPrice, 3, 'COMMA')} + '원'"></span>
                    </div>
                    <div class="line" style="margin-left: 10px; font-size: 0.9em;">
                        <span>수량</span>
                        <span th:text="${item.quantity}"></span>
                    </div>
                </div>
                <div class="line">
                    <span>메뉴금액</span>
                    <strong th:text="${#numbers.formatInteger(cartData.totalAmount, 3, 'COMMA')} + '원'"></strong>
                </div>
                <div class="line">
                    <span>배달팁</span>
                    <strong th:text="${#numbers.formatInteger(cartData.deliveryFee, 3, 'COMMA')} + '원'"></strong>
                </div>
                <div class="line discount" th:if="${cartData.discountAmount > 0}">
                    <span>총 할인받은 금액</span>
                    <strong th:text="'-' + ${#numbers.formatInteger(cartData.discountAmount, 3, 'COMMA')} + '원'"></strong>
                </div>
                <div class="divider"></div>
                <div class="line total">
                    <span>결제금액</span>
                    <strong th:text="${#numbers.formatInteger(cartData.finalAmount, 3, 'COMMA')} + '원'"></strong>
                </div>
            </div>
            <div class="benefit">무료배달 1,000원 할인</div>
        </div>
    </section>

    <!-- 약관/안내 -->
    <section class="agreements">
        <div class="item">㈜우아한형제들 배달상품 주의사항 동의</div>
        <div class="item">개인정보 제3자 제공 동의</div>
        <div class="confirm">위 내용을 확인하였으며 결제에 동의합니다.</div>
    </section>

    <!-- 하단 고정 바 -->
    <footer class="bottom-bar">
        <div class="benefit-pill">무료배달 1,000원 할인</div>
        <button class="cta" th:if="${cartData}" th:text="${#numbers.formatInteger(cartData.finalAmount, 3, 'COMMA')} + '원 결제하기'" id="paymentButton"></button>
    </footer>
</div>

<!-- 쿠폰 선택 모달 -->
<div id="couponModal" class="modal" style="display:none;">
    <div class="modal-content coupon-modal-content">
        <div class="modal-header">
            <h3>쿠폰 선택</h3>
            <button class="modal-close" onclick="toggleCouponModal()">×</button>
        </div>
        <div class="modal-body">
            <div th:if="${couponCount == 0}" class="empty-coupon">
                <p>사용 가능한 쿠폰이 없습니다.</p>
            </div>
            <div th:if="${couponCount > 0}" class="coupon-list">
                <div class="coupon-item" th:each="coupon : ${coupons}" 
                     th:attr="data-coupon-id=${coupon.userCouponId},
                              data-discount=${coupon.coupon.discountAmount},
                              data-min-order=${coupon.coupon.minOrderAmount}"
                     onclick="selectCoupon(this)">
                    <div class="coupon-info">
                        <div class="coupon-amount" th:text="${#numbers.formatInteger(coupon.coupon.discountAmount, 0, 'COMMA')} + '원 할인'">5,000원 할인</div>
                        <div class="coupon-name" th:text="${coupon.coupon.couponName}">쿠폰명</div>
                        <div class="coupon-condition" th:text="'최소주문 ' + ${#numbers.formatInteger(coupon.coupon.minOrderAmount, 0, 'COMMA')} + '원'">최소주문 15,000원</div>
                        <div class="coupon-expire" th:text="'~' + ${#temporals.format(coupon.expiresAt, 'yyyy.MM.dd')} + '까지'">~2025.12.31까지</div>
                    </div>
                    <div class="coupon-select-btn">선택</div>
                </div>
                <div class="coupon-item no-coupon" onclick="selectCoupon(this)" data-coupon-id="">
                    <div class="coupon-info">
                        <div class="coupon-name">쿠폰 사용 안 함</div>
                    </div>
                    <div class="coupon-select-btn">선택</div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
}

.coupon-modal-content {
    background: white;
    border-radius: 15px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: bold;
}

.modal-close {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: #999;
    padding: 0;
    width: 30px;
    height: 30px;
}

.modal-body {
    padding: 20px;
    overflow-y: auto;
    flex: 1;
}

.empty-coupon {
    text-align: center;
    padding: 40px 20px;
    color: #999;
}

.coupon-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.coupon-item {
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: all 0.3s;
}

.coupon-item:hover {
    border-color: #2ac1bc;
    background: #f8fffe;
}

.coupon-item.selected {
    border-color: #2ac1bc;
    background: #f0fffe;
}

.coupon-item.no-coupon {
    border-style: dashed;
}

.coupon-info {
    flex: 1;
}

.coupon-amount {
    font-size: 20px;
    font-weight: bold;
    color: #ff6b35;
    margin-bottom: 5px;
}

.coupon-name {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin-bottom: 5px;
}

.coupon-condition {
    font-size: 13px;
    color: #666;
    margin-bottom: 3px;
}

.coupon-expire {
    font-size: 12px;
    color: #999;
}

.coupon-select-btn {
    padding: 8px 20px;
    background: #2ac1bc;
    color: white;
    border-radius: 20px;
    font-size: 14px;
    font-weight: bold;
}

.coupon-item:hover .coupon-select-btn {
    background: #25a9a4;
}
</style>

<script>
let selectedCouponId = null;
let selectedCouponDiscount = 0;

function toggleCouponModal() {
    const modal = document.getElementById('couponModal');
    modal.style.display = modal.style.display === 'none' ? 'flex' : 'none';
}

function selectCoupon(element) {
    // 이전 선택 해제
    document.querySelectorAll('.coupon-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    // 현재 선택
    element.classList.add('selected');
    
    const couponId = element.getAttribute('data-coupon-id');
    const discount = parseInt(element.getAttribute('data-discount') || '0');
    const minOrder = parseInt(element.getAttribute('data-min-order') || '0');
    
    // 최소 주문 금액 확인
    const container = document.querySelector('.container');
    const totalAmount = parseInt(container.getAttribute('data-price'));
    
    if (couponId && minOrder > totalAmount) {
        alert(`최소 주문 금액 ${minOrder.toLocaleString()}원 이상이어야 사용 가능합니다.`);
        element.classList.remove('selected');
        return;
    }
    
    selectedCouponId = couponId;
    selectedCouponDiscount = couponId ? discount : 0;
    
    // 할인 금액 재계산
    recalculateTotal();
    
    // 선택된 쿠폰 텍스트 업데이트
    const selectedText = document.getElementById('selectedCouponText');
    if (couponId) {
        selectedText.textContent = `${discount.toLocaleString()}원 할인 쿠폰 적용`;
        selectedText.style.color = '#ff6b35';
        selectedText.style.fontWeight = 'bold';
    } else {
        selectedText.textContent = '쿠폰을 선택해주세요';
        selectedText.style.color = '';
        selectedText.style.fontWeight = '';
    }
    
    // 모달 닫기
    toggleCouponModal();
}

function recalculateTotal() {
    const container = document.querySelector('.container');
    const totalAmount = parseInt(container.getAttribute('data-price'));
    const deliveryFee = parseInt(container.getAttribute('data-delivery'));
    const originalDiscount = parseInt(container.getAttribute('data-discount'));
    
    // 새로운 총 할인 금액 = 기존 할인 + 쿠폰 할인
    const newTotalDiscount = originalDiscount + selectedCouponDiscount;
    const newFinalAmount = totalAmount + deliveryFee - newTotalDiscount;
    
    // 화면 업데이트
    const discountLine = document.querySelector('.line.discount strong');
    const totalLine = document.querySelector('.line.total strong');
    const paymentButton = document.getElementById('paymentButton');
    
    if (discountLine) {
        discountLine.textContent = `-${newTotalDiscount.toLocaleString()}원`;
    }
    
    if (totalLine) {
        totalLine.textContent = `${newFinalAmount.toLocaleString()}원`;
    }
    
    if (paymentButton) {
        paymentButton.textContent = `${newFinalAmount.toLocaleString()}원 결제하기`;
    }
    
    // data 속성도 업데이트
    container.setAttribute('data-total', newFinalAmount);
}

// order.js의 결제 함수에서 selectedCouponId 사용
window.getSelectedCouponId = function() {
    return selectedCouponId;
};
</script>

</body>
</html>
